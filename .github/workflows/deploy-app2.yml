name: Deploy PAPL Comparison App to Render

on:
  push:
    branches: ["main"]
    paths:
      - "apps/02-papl-comparison/**"
      - "shared/**"
      - ".github/workflows/deploy-app2.yml"

jobs:
  deploy:
    name: Deploy App 2 (PAPL Comparison)
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Sanity check: ensure Dockerfile exists
      - name: Verify Dockerfile exists
        run: |
          if [ ! -f apps/02-papl-comparison/Dockerfile ]; then
            echo "ERROR: Dockerfile missing in apps/02-papl-comparison"
            exit 1
          fi

      # Lint Python (optional but recommended)
      - name: Run basic flake8 lint
        uses: py-actions/flake8@v2
        with:
          max-line-length: "120"
        continue-on-error: true # donâ€™t block deployment yet

      # Build Docker image to match Render environment
      - name: Build Docker image
        run: |
          docker build \
            -f apps/02-papl-comparison/Dockerfile \
            -t papl-comparison-app .

      # Install Render CLI
      - name: Install render-cli
        run: |
          curl -L https://render.com/static/render-cli/render-linux-amd64 -o render
          chmod +x render
          sudo mv render /usr/local/bin/

      # Deploy to Render
      - name: Deploy service to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          render services update \
            --service-id ${{ secrets.RENDER_SERVICE_ID_APP2 }} \
            --branch main \
            --clear-cache
