"""
PAPL Digital First - App 2: PAPL Comparison Tool

Semantic comparison of PAPL .docx documents with AWS S3 integration
"""

import streamlit as st
import sys
import os

# Add shared modules to path
# Works both locally and in Docker
if os.path.exists('../../shared'):
    # Local development
    sys.path.append('../../shared')
elif os.path.exists('/app/shared'):
    # Docker container
    sys.path.append('/app/shared')
else:
    # Fallback: try relative to current file
    sys.path.append(os.path.join(os.path.dirname(__file__), '../../shared'))

from aws_storage import S3Storage
from papl_parser import PAPLParser
from semantic_comparer import SemanticComparer

# Load environment variables
from dotenv import load_dotenv
load_dotenv('../../.env')

# Page config
st.set_page_config(
    page_title="PAPL Digital First - Document Comparison",
    page_icon="üìä",
    layout="wide"
)

# NDIA Brand Colors
NDIA_BLUE = "#003087"
NDIA_ACCENT = "#00B5E2"

# Custom CSS
st.markdown(f"""
<style>
    .main-header {{
        background: linear-gradient(135deg, {NDIA_BLUE} 0%, {NDIA_ACCENT} 100%);
        padding: 20px;
        border-radius: 10px;
        color: white;
        text-align: center;
        margin-bottom: 30px;
    }}
    .stat-box {{
        background-color: #f0f2f6;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid {NDIA_BLUE};
    }}
    .change-added {{
        background-color: #d4edda;
        border-left: 4px solid #28a745;
        padding: 10px;
        margin: 5px 0;
    }}
    .change-removed {{
        background-color: #f8d7da;
        border-left: 4px solid #dc3545;
        padding: 10px;
        margin: 5px 0;
    }}
    .change-modified {{
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        margin: 5px 0;
    }}
</style>
""", unsafe_allow_html=True)

# Initialize session state
if 'comparison_complete' not in st.session_state:
    st.session_state.comparison_complete = False
if 'old_parsed' not in st.session_state:
    st.session_state.old_parsed = None
if 'new_parsed' not in st.session_state:
    st.session_state.new_parsed = None
if 'comparison_results' not in st.session_state:
    st.session_state.comparison_results = None
if 'old_s3_key' not in st.session_state:
    st.session_state.old_s3_key = None
if 'new_s3_key' not in st.session_state:
    st.session_state.new_s3_key = None

# Header
st.markdown("""
<div class="main-header">
    <h1>üìä PAPL Digital First</h1>
    <h3>Semantic Document Comparison Tool</h3>
    <p>Parse, Compare, and Understand PAPL Changes</p>
</div>
""", unsafe_allow_html=True)

# Sidebar
with st.sidebar:
    st.markdown("### ‚öôÔ∏è Configuration")
    
    # AWS Status
    st.markdown("#### AWS Connection")
    try:
        storage = S3Storage()
        if storage.ensure_bucket_exists():
            st.success("‚úÖ AWS S3 Connected")
            st.caption(f"Bucket: `{storage.bucket_name}`")
        else:
            st.error("‚ùå S3 Bucket Access Failed")
    except Exception as e:
        st.error(f"‚ùå AWS Error: {str(e)[:50]}")
    
    st.markdown("---")
    
    # Comparison Options
    st.markdown("#### Comparison Options")
    
    compare_pricing = st.checkbox("Compare Pricing Data", value=True)
    compare_rules = st.checkbox("Compare Business Rules", value=True)
    compare_guidance = st.checkbox("Compare Guidance Text", value=True)
    compare_tables = st.checkbox("Compare Table Structures", value=True)
    
    upload_to_s3 = st.checkbox("Upload to AWS S3", value=True, 
                                help="Store documents and results in S3 for AI Assistant")
    
    st.markdown("---")
    
    # Info
    st.markdown("#### üìö About")
    st.info("""
    **PAPL Digital First** transforms PAPL documents into structured, semantic data.
    
    This tool:
    - Parses PAPL into JSON/YAML/MD
    - Compares semantically
    - Tracks pricing, rules, guidance
    - Stores in AWS for AI chatbot
    """)
    
    st.markdown("---")
    st.caption("Markets Delivery | NDIA")

# Main content
tab1, tab2, tab3 = st.tabs(["üì§ Upload & Compare", "üìä Results", "üíæ Export & Storage"])

with tab1:
    st.markdown("## Upload PAPL Documents")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### üìÑ Version 1 (Older)")
        old_file = st.file_uploader(
            "Upload older PAPL version",
            type=['docx'],
            key='old_file',
            help="Upload the older/baseline PAPL document"
        )
        
        if old_file:
            st.success(f"‚úì Loaded: {old_file.name}")
            st.caption(f"Size: {old_file.size / 1024:.1f} KB")
    
    with col2:
        st.markdown("### üìÑ Version 2 (Newer)")
        new_file = st.file_uploader(
            "Upload newer PAPL version",
            type=['docx'],
            key='new_file',
            help="Upload the newer/updated PAPL document"
        )
        
        if new_file:
            st.success(f"‚úì Loaded: {new_file.name}")
            st.caption(f"Size: {new_file.size / 1024:.1f} KB")
    
    st.markdown("---")
    
    # Compare button
    if old_file and new_file:
        if st.button("üîç Parse and Compare Documents", type="primary", use_container_width=True):
            with st.spinner("üîÑ Processing documents..."):
                try:
                    # Initialize components
                    parser = PAPLParser()
                    comparer = SemanticComparer()
                    
                    # Step 1: Upload to S3 (if enabled)
                    if upload_to_s3:
                        st.info("üì§ Uploading documents to AWS S3...")
                        old_s3_key = storage.upload_source_document(
                            file_data=old_file.read(),
                            document_type='papl',
                            filename=old_file.name,
                            metadata={'version': 'old', 'comparison_session': datetime.now().isoformat()}
                        )
                        old_file.seek(0)  # Reset file pointer
                        
                        new_s3_key = storage.upload_source_document(
                            file_data=new_file.read(),
                            document_type='papl',
                            filename=new_file.name,
                            metadata={'version': 'new', 'comparison_session': datetime.now().isoformat()}
                        )
                        new_file.seek(0)  # Reset file pointer
                        
                        st.session_state.old_s3_key = old_s3_key
                        st.session_state.new_s3_key = new_s3_key
                        st.success(f"‚úì Uploaded to S3")
                    
                    # Step 2: Parse documents
                    st.info("üîç Parsing document structures...")
                    old_parsed = parser.parse(old_file)
                    new_parsed = parser.parse(new_file)
                    
                    st.session_state.old_parsed = old_parsed
                    st.session_state.new_parsed = new_parsed
                    
                    # Step 3: Upload parsed data to S3 (if enabled)
                    if upload_to_s3 and old_s3_key and new_s3_key:
                        st.info("üíæ Storing parsed data...")
                        
                        # Store JSON/YAML/MD for old version
                        storage.upload_processed_data(
                            data=old_parsed['pricing_data'],
                            source_s3_key=old_s3_key,
                            format='json'
                        )
                        storage.upload_processed_data(
                            data=parser.export_to_yaml(old_parsed),
                            source_s3_key=old_s3_key,
                            format='yaml'
                        )
                        storage.upload_processed_data(
                            data=parser.export_to_markdown(old_parsed),
                            source_s3_key=old_s3_key,
                            format='markdown'
                        )
                        
                        # Store JSON/YAML/MD for new version
                        storage.upload_processed_data(
                            data=new_parsed['pricing_data'],
                            source_s3_key=new_s3_key,
                            format='json'
                        )
                        storage.upload_processed_data(
                            data=parser.export_to_yaml(new_parsed),
                            source_s3_key=new_s3_key,
                            format='yaml'
                        )
                        storage.upload_processed_data(
                            data=parser.export_to_markdown(new_parsed),
                            source_s3_key=new_s3_key,
                            format='markdown'
                        )
                        
                        st.success("‚úì Parsed data stored in S3")
                    
                    # Step 4: Perform semantic comparison
                    st.info("‚öñÔ∏è Comparing documents semantically...")
                    comparison_results = comparer.compare(old_parsed, new_parsed)
                    
                    st.session_state.comparison_results = comparison_results
                    
                    # Step 5: Store comparison results to S3 (if enabled)
                    if upload_to_s3 and old_s3_key and new_s3_key:
                        comparison_s3_key = storage.upload_comparison(
                            comparison_data=comparison_results,
                            comparison_type='papl',
                            old_doc_key=old_s3_key,
                            new_doc_key=new_s3_key
                        )
                        st.session_state.comparison_s3_key = comparison_s3_key
                        st.success(f"‚úì Comparison results stored")
                    
                    st.session_state.comparison_complete = True
                    st.success("‚úÖ Comparison Complete!")
                    st.balloons()
                    
                    # Switch to results tab
                    st.info("üëâ View results in the 'Results' tab")
                    
                except Exception as e:
                    st.error(f"‚ùå Error during comparison: {str(e)}")
                    st.exception(e)
    else:
        st.warning("‚ö†Ô∏è Please upload both PAPL versions to begin comparison")

with tab2:
    st.markdown("## Comparison Results")
    
    if not st.session_state.comparison_complete:
        st.info("üëà Upload and compare documents in the 'Upload & Compare' tab first")
    else:
        results = st.session_state.comparison_results
        old_parsed = st.session_state.old_parsed
        new_parsed = st.session_state.new_parsed
        
        # Summary Dashboard
        st.markdown("### üìä Summary Dashboard")
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.markdown("""
            <div class="stat-box">
                <h4>üìà Pricing Changes</h4>
                <p style='font-size: 24px; color: #003087; font-weight: bold;'>
                    {items}
                </p>
                <p>Items Changed</p>
            </div>
            """.format(
                items=results['pricing_changes']['summary']['prices_changed']
            ), unsafe_allow_html=True)
        
        with col2:
            st.markdown("""
            <div class="stat-box">
                <h4>‚öñÔ∏è Business Rules</h4>
                <p style='font-size: 24px; color: #003087; font-weight: bold;'>
                    {rules}
                </p>
                <p>Rules Modified</p>
            </div>
            """.format(
                rules=results['rule_changes']['summary']['rules_added'] + 
                      results['rule_changes']['summary']['rules_modified']
            ), unsafe_allow_html=True)
        
        with col3:
            st.markdown("""
            <div class="stat-box">
                <h4>üìù Guidance</h4>
                <p style='font-size: 24px; color: #003087; font-weight: bold;'>
                    {sections}
                </p>
                <p>Sections Updated</p>
            </div>
            """.format(
                sections=results['guidance_changes']['summary']['sections_modified']
            ), unsafe_allow_html=True)
        
        with col4:
            st.markdown("""
            <div class="stat-box">
                <h4>üìã Tables</h4>
                <p style='font-size: 24px; color: #003087; font-weight: bold;'>
                    {tables}
                </p>
                <p>Structure Changes</p>
            </div>
            """.format(
                tables=results['table_structure_changes']['summary']['structure_changed']
            ), unsafe_allow_html=True)
        
        st.markdown("---")
        
        # Detailed Results
        if compare_pricing:
            with st.expander("üìà Pricing Changes", expanded=True):
                pricing = results['pricing_changes']
                
                st.markdown(f"""
                **Summary:**
                - Tables Modified: {pricing['summary']['tables_modified']}
                - Items Added: {pricing['summary']['items_added']}
                - Items Removed: {pricing['summary']['items_removed']}
                - Prices Changed: {pricing['summary']['prices_changed']}
                """)
                
                # Show price changes
                for detail in pricing['details']:
                    if detail['type'] == 'table_modified' and 'changes' in detail:
                        changes = detail['changes']
                        
                        if changes.get('prices_changed'):
                            st.markdown(f"#### Table {detail['table_index'] + 1} - Price Changes")
                            
                            price_df = pd.DataFrame(changes['prices_changed'])
                            st.dataframe(price_df, use_container_width=True)
        
        if compare_rules:
            with st.expander("‚öñÔ∏è Business Rule Changes", expanded=True):
                rules = results['rule_changes']
                
                st.markdown(f"""
                **Summary:**
                - Rules Added: {rules['summary']['rules_added']}
                - Rules Removed: {rules['summary']['rules_removed']}
                - Rules Modified: {rules['summary']['rules_modified']}
                - High Priority Changes: {rules['summary']['high_priority_changes']}
                """)
                
                # Show rule changes
                for detail in rules['details'][:10]:  # First 10
                    if detail['type'] == 'rule_added':
                        st.markdown(f"""
                        <div class="change-added">
                            <strong>‚ûï Rule Added ({detail['priority']} priority)</strong><br>
                            Type: {detail['rule_type']}<br>
                            {detail['text']}
                        </div>
                        """, unsafe_allow_html=True)
                    elif detail['type'] == 'rule_removed':
                        st.markdown(f"""
                        <div class="change-removed">
                            <strong>‚ûñ Rule Removed ({detail['priority']} priority)</strong><br>
                            Type: {detail['rule_type']}<br>
                            {detail['text']}
                        </div>
                        """, unsafe_allow_html=True)
        
        if compare_guidance:
            with st.expander("üìù Guidance Changes", expanded=True):
                guidance = results['guidance_changes']
                
                st.markdown(f"""
                **Summary:**
                - Sections Added: {guidance['summary']['sections_added']}
                - Sections Removed: {guidance['summary']['sections_removed']}
                - Sections Modified: {guidance['summary']['sections_modified']}
                - Word Count Change: {guidance['summary']['word_count_change']:+d} words
                """)
                
                # Show section changes
                for detail in guidance['details'][:10]:  # First 10
                    if detail['type'] == 'section_added':
                        st.markdown(f"""
                        <div class="change-added">
                            <strong>‚ûï Section Added:</strong> {detail['heading']}<br>
                            Paragraphs: {detail['paragraph_count']}
                        </div>
                        """, unsafe_allow_html=True)
                    elif detail['type'] == 'section_removed':
                        st.markdown(f"""
                        <div class="change-removed">
                            <strong>‚ûñ Section Removed:</strong> {detail['heading']}<br>
                            Paragraphs: {detail['paragraph_count']}
                        </div>
                        """, unsafe_allow_html=True)
                    elif detail['type'] == 'section_modified':
                        st.markdown(f"""
                        <div class="change-modified">
                            <strong>‚úèÔ∏è Section Modified:</strong> {detail['heading']}<br>
                            Change: {detail['change_type']} ({detail['old_length']} ‚Üí {detail['new_length']} words)
                        </div>
                        """, unsafe_allow_html=True)
        
        if compare_tables:
            with st.expander("üìã Table Structure Changes", expanded=True):
                tables = results['table_structure_changes']
                
                st.markdown(f"""
                **Summary:**
                - Tables Added: {tables['summary']['tables_added']}
                - Tables Removed: {tables['summary']['tables_removed']}
                - Structure Changed: {tables['summary']['structure_changed']}
                - Content Changed: {tables['summary']['content_changed']}
                """)
                
                # Show structural changes
                for detail in tables['details']:
                    if detail['type'] == 'table_modified' and detail['structure_changed']:
                        st.markdown(f"""
                        <div class="change-modified">
                            <strong>‚ö†Ô∏è Table {detail['table_index'] + 1} Structure Changed</strong><br>
                            Rows: {detail['old_dimensions']['rows']} ‚Üí {detail['new_dimensions']['rows']} 
                            ({'+' if detail['row_diff'] > 0 else ''}{detail['row_diff']})<br>
                            Columns: {detail['old_dimensions']['cols']} ‚Üí {detail['new_dimensions']['cols']} 
                            ({'+' if detail['col_diff'] > 0 else ''}{detail['col_diff']})
                        </div>
                        """, unsafe_allow_html=True)

with tab3:
    st.markdown("## Export & Storage")
    
    if not st.session_state.comparison_complete:
        st.info("üëà Complete a comparison first to export results")
    else:
        st.markdown("### üíæ AWS S3 Storage")
        
        if st.session_state.get('old_s3_key') and st.session_state.get('new_s3_key'):
            st.success("‚úÖ Documents stored in AWS S3")
            
            col1, col2 = st.columns(2)
            with col1:
                st.code(st.session_state.old_s3_key, language='text')
            with col2:
                st.code(st.session_state.new_s3_key, language='text')
            
            st.info("üí° These documents are now available to the AI Assistant for querying")
        
        st.markdown("---")
        st.markdown("### üì• Export Options")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            # Export as JSON
            if st.button("üìÑ Export as JSON", use_container_width=True):
                json_data = json.dumps(st.session_state.comparison_results, indent=2)
                st.download_button(
                    label="Download JSON",
                    data=json_data,
                    file_name=f"papl_comparison_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json",
                    mime="application/json"
                )
        
        with col2:
            # Export as CSV (pricing changes)
            if st.button("üìä Export as CSV", use_container_width=True):
                # Create CSV from pricing changes
                pricing_data = []
                for detail in st.session_state.comparison_results['pricing_changes']['details']:
                    if detail['type'] == 'table_modified' and 'changes' in detail:
                        for price_change in detail['changes'].get('prices_changed', []):
                            pricing_data.append(price_change)
                
                if pricing_data:
                    df = pd.DataFrame(pricing_data)
                    csv = df.to_csv(index=False)
                    st.download_button(
                        label="Download CSV",
                        data=csv,
                        file_name=f"pricing_changes_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                        mime="text/csv"
                    )
                else:
                    st.warning("No pricing changes to export")
        
        with col3:
            # Export as Markdown Report
            if st.button("üìù Export as Markdown", use_container_width=True):
                # Generate markdown report
                results = st.session_state.comparison_results
                md_report = f"""# PAPL Comparison Report

**Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

## Summary

### Pricing Changes
- Tables Modified: {results['pricing_changes']['summary']['tables_modified']}
- Items Added: {results['pricing_changes']['summary']['items_added']}
- Items Removed: {results['pricing_changes']['summary']['items_removed']}
- Prices Changed: {results['pricing_changes']['summary']['prices_changed']}

### Business Rules
- Rules Added: {results['rule_changes']['summary']['rules_added']}
- Rules Removed: {results['rule_changes']['summary']['rules_removed']}
- Rules Modified: {results['rule_changes']['summary']['rules_modified']}
- High Priority Changes: {results['rule_changes']['summary']['high_priority_changes']}

### Guidance
- Sections Added: {results['guidance_changes']['summary']['sections_added']}
- Sections Removed: {results['guidance_changes']['summary']['sections_removed']}
- Sections Modified: {results['guidance_changes']['summary']['sections_modified']}
- Word Count Change: {results['guidance_changes']['summary']['word_count_change']} words

### Tables
- Structure Changed: {results['table_structure_changes']['summary']['structure_changed']}
- Content Changed: {results['table_structure_changes']['summary']['content_changed']}

---

*Generated by PAPL Digital First - Semantic Comparison Tool*
"""
                
                st.download_button(
                    label="Download Markdown",
                    data=md_report,
                    file_name=f"papl_comparison_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md",
                    mime="text/markdown"
                )

# Footer with feedback
st.markdown("---")
st.markdown("## üí¨ Feedback & Support")

with st.expander("üìß Send Feedback", expanded=False):
    st.markdown("""
    Found a bug? Have a suggestion? Send feedback to Stuart Smith.
    """)
    
    feedback_name = st.text_input("Your Name (optional)")
    feedback_email = st.text_input("Your Email (optional)")
    feedback_type = st.selectbox("Feedback Type", 
                                  ["Bug Report", "Feature Request", "Question", "General Comment"])
    feedback_text = st.text_area("Your Feedback", height=150)
    
    if st.button("üìß Send Feedback"):
        if feedback_text:
            import urllib.parse
            
            subject = f"PAPL Digital First Feedback: {feedback_type}"
            body = f"""
PAPL DIGITAL FIRST - APP 2 FEEDBACK
==================================

From: {feedback_name or 'Anonymous'}
Email: {feedback_email or 'Not provided'}
Type: {feedback_type}

FEEDBACK:
{feedback_text}

---
Sent from PAPL Digital First - App 2 (PAPL Comparison Tool)
"""
            
            mailto_link = f"mailto:stuart.smith@ndis.gov.au?subject={urllib.parse.quote(subject)}&body={urllib.parse.quote(body)}"
            
            st.success("‚úì Feedback prepared!")
            st.markdown(f'<a href="{mailto_link}" target="_blank">üìß Open in Email</a>', unsafe_allow_html=True)
            
            st.download_button(
                label="üì• Download Feedback",
                data=body,
                file_name=f"feedback_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt",
                mime="text/plain"
            )
        else:
            st.error("Please enter your feedback")

st.markdown("---")
st.markdown("""
<div style='text-align: center; color: #666; padding: 20px;'>
<p><strong>PAPL Digital First - App 2: PAPL Comparison Tool</strong></p>
<p>Markets Delivery | NDIA</p>
<p>Semantic comparison with AWS integration</p>
</div>
""", unsafe_allow_html=True)
